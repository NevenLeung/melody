"use strict";angular.module("Melody",["ui.router","ngResource","ngDialog","angularSoundManager","ngAnimate","ngSanitize","ui.bootstrap","angularAwesomeSlider","angular-sortable-view","xeditable"]).config(["$stateProvider","$urlRouterProvider","$uibTooltipProvider",function(t,e,o){o.setTriggers({mouseenter:"outsideClick"}),t.state("app",{url:"/",views:{player:{templateUrl:"views/player.html",controller:"PlayerCtrl"},header:{templateUrl:"views/header.html",controller:"HeaderCtrl"},content:{templateUrl:"views/home.html",controller:"HomeCtrl"}}}).state("app.song",{url:"song/:id",views:{"content@":{templateUrl:"views/song-info.html",controller:"SongCtrl"}}}).state("app.personal",{url:"personal",views:{"content@":{templateUrl:"views/personal-center.html",controller:"PersonalCtrl"}}}).state("app.user",{url:"user/:id",views:{"content@":{templateUrl:"views/user-info.html",controller:"UserCtrl"}}}).state("app.artist",{url:"artist/:id",views:{"content@":{templateUrl:"views/artist.html",controller:"ArtistCtrl"}}}).state("app.about",{url:"about",views:{"content@":{templateUrl:"views/about.html",controller:"AboutCtrl"}}}),e.otherwise("/")}]).run(["editableOptions",function(t){t.theme="bs3"}]),angular.module("Melody").constant("baseUrl","https://neven.cc:3443/").factory("songFactory",["$resource","baseUrl",function(t,e){return{song:t(e+"songs/:songId",null,null),comment:t(e+"songs/:songId/comments",null,null)}}]).factory("artistFactory",["$resource","baseUrl",function(t,e){return t(e+"artists/:artistId",null,null)}]).factory("userFactory",["$resource","baseUrl",function(t,e){return{user:t(e+"users/:id",null,{update:{method:"PUT"}}),favorite:t(e+"users/:id/favorites/:songID",{id:"@id",songID:"@songID"},{update:{method:"PUT"}}),register:t(e+"users/register"),login:t(e+"users/login"),logout:t(e+"users/logout")}}]).factory("localStorage",["$window",function(o){return{store:function(t,e){o.localStorage[t]=e},get:function(t,e){return o.localStorage[t]||e},remove:function(t){o.localStorage.removeItem(t)},storeObject:function(t,e){o.localStorage[t]=JSON.stringify(e)},getObject:function(t,e){return JSON.parse(o.localStorage[t]||e)}}}]).factory("favFactory",["$rootScope","localStorage","userFactory",function(o,n,a){var t={},r=[];return t.updateFavoriteList=function(t){var e=n.getObject("Token","{}").userID;-1===(r=n.getObject(e,"[]")).indexOf(t.id)?(r.push(t.id),n.storeObject(e,r),a.favorite.update({id:e,songID:t.id},{}).$promise.then(function(t){},function(t){console.log(t)}),o.$broadcast("favoriteList: Update",{operation:"add",song:t})):(r.splice(r.indexOf(t.id),1),n.storeObject(e,r),a.favorite.remove({id:e,songID:t.id}).$promise.then(function(t){},function(t){console.log(t)}),o.$broadcast("favoriteList: Update",{operation:"remove",song:t}))},t.removeAll=function(){var t=n.getObject("Token","{}").userID;n.storeObject(t,"[]"),a.favorite.remove({id:t}).$promise.then(function(t){},function(t){console.log(t)}),o.$broadcast("favoriteList: Update",{operation:"removeAll"})},t.isInFavList=function(t){var e=n.getObject("Token","{}").userID;return-1!==(r=n.getObject(e,"[]")).indexOf(t.id)},t}]).factory("AuthFactory",["$resource","$http","localStorage","$rootScope","$window","ngDialog","userFactory",function(t,n,a,r,e,s,i){var o,l={},c="Token",u=!1,g="",f=void 0,m=a.getObject("userinfo","{}");function d(t){var e,o;u=!0,g=t.username,f=t.Token,n.defaults.headers.common["x-access-token"]=f,e=a.getObject("Token").userID,o=a.getObject(e,"[]"),i.favorite.get({id:e}).$promise.then(function(t){o.length<t.favorites.length&&(o=[],angular.forEach(t.favorites,function(t){o.push(t.songInfo._id)}),a.storeObject(e,o))})}return null!=(o=a.getObject(c,"{}")).username&&d(o),l.login=function(o){i.login.save(o,function(t){var e;e={username:o.username,Token:t.token,userID:t.id,avatar:t.avatar},a.storeObject(c,e),d(e),r.$broadcast("login: Successful")},function(t){u=!1;var e='                        <div class="ngdialog-message">                            <div><h4>Login Unsuccessful</h4></div><div><p>'+t.data.err.name+'</p></div><div class="ngdialog-buttons">                                <button type="button" class="ngdialog-button ngdialog-button-primary" ng-click=confirm("OK")>OK</button>                            </div>                        </div>';s.openConfirm({template:e,plain:"true"})})},l.logout=function(){i.logout.get(function(t){}),f=void 0,g="",u=!1,n.defaults.headers.common["x-access-token"]=f,a.remove(c),r.$broadcast("logout: Successful")},l.register=function(e){i.register.save(e,function(t){l.login({username:e.username,password:e.password}),e.rememberMe&&a.storeObject("userinfo",{username:e.username,password:e.password}),r.$broadcast("registration: Successful")},function(t){var e='                        <div class="ngdialog-message">                            <div><h4>Registration Unsuccessful</h4></div><div><p>'+t.data.err.name+"</p></div></div>";s.openConfirm({template:e,plain:"true"})})},l.isAuthenticated=function(){return u},l.getUsername=function(){return g},0!==Object.keys(m).length&&l.login(m),l}]),angular.module("Melody").controller("PlayerCtrl",["$scope","angularPlayer","$timeout","$rootScope","songFactory","favFactory","AuthFactory","ngDialog","baseUrl",function(a,r,t,s,e,i,o,n,l){function c(){e.song.get({},function(t){for(var e,o={},n=0;Object.keys(o).length<5;n++)o[JSON.stringify(t.data[(e=t.total,Math.floor(Math.random()*e))])]=n;a.songs=Object.keys(o).map(function(t){return JSON.parse(t)}),angular.forEach(a.songs,function(t){t.id=t._id,t.url=l+"music/"+t.url,t.favorite=i.isInFavList(t),r.addTrack(t)}),r.play(),s.$broadcast("track:id"),a.displayInfo=!0},function(t){console.log(t)})}c(),a.playIcon='<span class="fa fa-2x fa-play player-icon"></span>',a.pauseIcon='<span class="fa fa-2x fa-pause player-icon"></span>',a.sliderOptions={from:100,to:0,step:10,vertical:!0,callback:function(t){r.adjustVolumeSlider(t)}},a.toggleFavorite=function(t){o.isAuthenticated()?(i.updateFavoriteList(t),t.favorite=i.isInFavList(t)):n.open({template:"views/loginReminder.html",className:"ngdialog-theme-default"})},s.$on("favoriteList: Update",function(t,e){"removeAll"==e.operation&&angular.forEach(a.playlist,function(t){t.favorite=!1})}),a.spinIcon=function(){r.stop(),r.setCurrentTrack(null),r.clearPlaylist(function(){}),t(c,200),a.spinner=!0,t(function(){a.spinner=!1},1e3)},s.$on("player:playlist",function(t,e){a.displayInfo=0!==e.length}),s.$on("login: Successful",function(){angular.forEach(r.getPlaylist(),function(t){t.favorite=i.isInFavList(t)})}),s.$on("logout: Successful",function(){angular.forEach(r.getPlaylist(),function(t){t.favorite=!1})})}]).controller("HeaderCtrl",["$scope","$state","ngDialog","$rootScope","baseUrl","localStorage","AuthFactory",function(t,e,o,n,a,r,s){function i(){t.username=r.getObject("Token","{}").username,t.avatar=a+"images/avatar/"+r.getObject("Token","{}").avatar,t.userID=r.getObject("Token","{}").userID}t.baseUrl=a,t.isLoggedIn=s.isAuthenticated(),i(),t.openRegisterModal=function(){o.open({template:"views/register.html",scope:t,className:"ngdialog-theme-default",controller:"RegisterCtrl"})},t.openLoginModal=function(){o.open({template:"views/login.html",scope:t,className:"ngdialog-theme-default",controller:"LoginCtrl"})},t.doLogout=function(){t.isLoggedIn=!1,s.logout()},n.$on("login: Successful",function(){i(),t.isLoggedIn=!0}),n.$on("logout: Successful",function(){e.go("app")}),t.stateIs=function(t){return e.is(t)},t.avatarList=["001.jpg","002.jpg","003.jpg","004.jpg","005.jpg"]}]).controller("LoginCtrl",["$scope","ngDialog","$rootScope","AuthFactory","localStorage",function(t,e,o,n,a){t.loginData=a.getObject("userinfo","{}"),t.doLogin=function(){t.rememberMe&&a.storeObject("userinfo",t.loginData),n.login(t.loginData),e.close()}}]).controller("RegisterCtrl",["$scope","ngDialog","$rootScope","AuthFactory",function(t,e,o,n){t.registration={},t.loginData={},t.doRegistration=function(){n.register(t.registration),e.close()}}]).controller("HomeCtrl",["$scope","angularPlayer","$rootScope","$timeout","baseUrl",function(t,e,o,n,a){function r(){n(function(){t.songID=e.currentTrackData()._id,t.musicName=e.currentTrackData().title,t.albumName=e.currentTrackData().albumName,t.albumCover=t.baseUrl+"images/album/"+e.currentTrackData().albumCover,t.singerName=e.currentTrackData().artist,t.singerID=e.currentTrackData().artistID},100)}t.baseUrl=a,r(),o.$on("track:id",function(t,e){r()}),o.$on("track:progress",function(t,e){100===parseInt(e)&&r()})}]).controller("SongCtrl",["$scope","$stateParams","angularPlayer","songFactory","AuthFactory","ngDialog","baseUrl","$http","$q",function(e,t,o,n,a,r,s,i,l){e.commentContent="click to comment!",e.currentPage=1,e.itemsPerPage=5,e.maxSize=5,e.checkComment=function(){if(!a.isAuthenticated())return r.open({template:"views/loginReminder.html",className:"ngdialog-theme-default"}),""},e.submitComment=function(){e.currentPage=Math.ceil(e.totalItems/e.itemsPerPage),e.pageChange(),n.comment.save({songId:t.id},{comment:e.commentContent},function(t){},function(t){console.log(t)})},e.pageChange=function(){n.comment.get({songId:t.id,page:e.currentPage}).$promise.then(function(t){angular.forEach(t.docs,function(t){t.postedBy.avatar=s+"images/avatar/"+t.postedBy.avatar}),e.comments=t.docs,e.totalItems=t.total},function(t){console.log(t)})},e.songID=o.currentTrackData()._id,e.musicName=o.currentTrackData().title,e.albumName=o.currentTrackData().albumName,e.albumCover=s+"images/album/"+o.currentTrackData().albumCover,e.singerName=o.currentTrackData().artist,e.singerID=o.currentTrackData().artistID;var c=l.defer();i.get(s+"songs/"+t.id+"/comments",{page:e.currentPage}).then(function(t){e.totalItems=t.data.total,e.currentPage=Math.ceil(e.totalItems/e.itemsPerPage),e.pageChange(),c.resolve()},function(t){c.reject("error")})}]).controller("PersonalCtrl",["$scope","$state","$timeout","$rootScope","baseUrl","localStorage","userFactory","favFactory","$q","$http","AuthFactory","ngDialog","angularPlayer",function(o,t,e,n,a,r,s,i,l,c,u,g,f){o.favList=[],o.userInfo={};var m=r.getObject("Token","{}").userID,d=r.getObject(m,"[]");u.isAuthenticated()||(g.open({template:"views/loginReminder.html",className:"ngdialog-theme-default"}),t.go("app")),m&&s.favorite.get({id:m}).$promise.then(function(t){o.userInfo.username=t.username,o.userPhoto=a+"images/avatar/"+t.avatar,o.userInfo.introduction=t.introduction,angular.forEach(d,function(e){angular.forEach(t.favorites,function(t){e==t.songInfo._id&&(t.songInfo.id=t.songInfo._id,t.songInfo.url=a+"music/"+t.songInfo.url,o.favList.push(t.songInfo))})})},function(t){console.log(t)}),o.playAll=function(){f.stop(),f.setCurrentTrack(null),f.clearPlaylist(function(){}),e(function(){angular.forEach(o.favList,function(t){f.addTrack(t)}),f.play()},100)},o.changeFavListOrder=function(){d=[],angular.forEach(o.favList,function(t){d.push(t._id)}),r.storeObject(m,d)},o.removeOneFromFav=function(t){i.updateFavoriteList(t)},o.removeAllFromFav=function(){i.removeAll()},o.checkUsername=function(e){if(""==e)return"Username can not be empty!";var o=l.defer();return c.put(a+"users/"+m,{username:e}).then(function(t){"200"==(t=t||{}).status&&o.resolve()},function(t){500==t.status&&o.reject("Username "+e+" has been already used!")}),o.promise},o.saveUserInfo=function(){s.user.update({id:m},o.userInfo).$promise.then(function(t){},function(t){console.log(t)})},n.$on("favoriteList: Update",function(t,e){"add"==e.operation?o.favList.push(e.song):o.favList.splice(o.favList.indexOf(e.song),1)})}]).controller("UserCtrl",["$scope","angularPlayer","$stateParams","userFactory","baseUrl","$timeout",function(e,o,t,n,a,r){e.favList=[],n.favorite.get({id:t.id}).$promise.then(function(t){e.userName=t.username,e.userPhoto=a+"images/avatar/"+t.avatar,e.introduction=t.introduction,angular.forEach(t.favorites,function(t){t.songInfo.id=t.songInfo._id,t.songInfo.url=a+"music/"+t.songInfo.url,e.favList.push(t.songInfo)})},function(t){console.log(t)}),e.playAll=function(){o.stop(),o.setCurrentTrack(null),o.clearPlaylist(function(){}),r(function(){angular.forEach(e.favList,function(t){o.addTrack(t)}),o.play()},100)}}]).controller("ArtistCtrl",["$scope","artistFactory","$stateParams","baseUrl",function(e,t,o,n){e.baseUrl=n,t.get({artistId:o.id}).$promise.then(function(t){e.artistPhoto=e.baseUrl+"images/artist/"+t.artistPhoto,e.artistName=t.artistName,e.introduction=t.introduction.replace(/\n/g,"\n\n"),e.recommended=t.recommended},function(t){console.log(t)})}]).controller("AboutCtrl",["baseUrl","$scope",function(t,e){e.baseUrl=t}]);